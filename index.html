<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aghatta XV</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCWq5k87voGQHlRPquvI1P5W1eme32E5f4",
    authDomain: "livro-aghatta.firebaseapp.com",
    databaseURL: "https://livro-aghatta-default-rtdb.firebaseio.com",
    projectId: "livro-aghatta",
    storageBucket: "livro-aghatta.appspot.com",
    messagingSenderId: "491625108244",
    appId: "1:491625108244:web:3afdfda239f9d0904ca801"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // Postagem
  window.postar = function() {
    const nome = document.getElementById('nome').value.trim();
    const legenda = document.getElementById('legenda').value.trim();
    const arquivo = document.getElementById('arquivo').files[0];

    if(!nome) return alert('Informe seu nome.');

    if(arquivo) {
      const storageRef = sRef(storage, 'fotos/' + arquivo.name);
      const uploadTask = uploadBytesResumable(storageRef, arquivo);

      uploadTask.on('state_changed',
        snapshot => {},
        error => alert('Erro no upload: ' + error),
        () => {
          getDownloadURL(uploadTask.snapshot.ref).then(url => {
            push(ref(db, 'posts'), { nome, legenda, url, likes: 0, comments: {}, timestamp: Date.now() });
            document.getElementById('arquivo').value = '';
            document.getElementById('legenda').value = '';
          });
        }
      );
    } else {
      push(ref(db, 'posts'), { nome, legenda, url: '', likes: 0, comments: {}, timestamp: Date.now() });
      document.getElementById('legenda').value = '';
    }
  };

  // Feed em tempo real
  const feedContainer = document.getElementById('feed');
  onValue(ref(db, 'posts'), snapshot => {
    feedContainer.innerHTML = '';
    snapshot.forEach(child => {
      const data = child.val();
      const postKey = child.key;

      const div = document.createElement('div');
      div.classList.add('post');

      let html = `<strong class='gold'>${data.nome}</strong> - <small>${new Date(data.timestamp).toLocaleString()}</small><br>`;
      if(data.legenda) html += `<p>${data.legenda}</p>`;
      if(data.url) html += `<img src='${data.url}' alt='Foto' />`;
      html += `<div class='acoes'>
                <button onclick="curtir('${postKey}', ${data.likes})">‚ù§Ô∏è ${data.likes}</button>
                <button onclick="toggleComentarios('${postKey}')">üí¨ ${data.comments ? Object.keys(data.comments).length : 0}</button>
              </div>`;
      html += `<div id='comentarios-${postKey}' class='comentarios' style='display:none;'>
                <input type='text' id='input-${postKey}' placeholder='Escreva um coment√°rio...' />
                <button onclick="comentar('${postKey}')">Comentar</button>
                <div id='lista-comentarios-${postKey}'></div>
              </div>`;

      div.innerHTML = html;
      feedContainer.appendChild(div);

      // Mostrar coment√°rios existentes
      const lista = document.getElementById(`lista-comentarios-${postKey}`);
      if(data.comments) {
        lista.innerHTML = '';
        Object.values(data.comments).forEach(c => {
          const p = document.createElement('p');
          p.innerHTML = `<strong class='gold'>${c.nome}</strong>: ${c.texto}`;
          lista.appendChild(p);
        });
      }
    });
  });

  window.curtir = function(key, likes) {
    update(ref(db, 'posts/' + key), { likes: likes + 1 });
  };

  window.toggleComentarios = function(key) {
    const div = document.getElementById(`comentarios-${key}`);
    div.style.display = div.style.display === 'none' ? 'block' : 'none';
  };

  window.comentar = function(key) {
    const input = document.getElementById(`input-${key}`);
    const texto = input.value.trim();
    const nome = document.getElementById('nome').value.trim();
    if(!nome || !texto) return alert('Informe seu nome e coment√°rio.');
    const commentRef = ref(db, `posts/${key}/comments`);
    push(commentRef, { nome, texto });
    input.value = '';
  };

</script>
<style>
  body { background: linear-gradient(180deg, #0b3b8f 0%, #06213f 100%); color: #D4AF37; font-family: sans-serif; margin:0; padding:0; }
  h1 { text-align:center; color:#D4AF37; margin:20px; }
  .gold { color:#D4AF37; }
  #formulario { display:flex; flex-direction:column; align-items:center; gap:10px; margin:20px; }
  input, textarea { padding:5px; border-radius:5px; border:none; width:90%; max-width:400px; }
  button { padding:8px 15px; border:none; border-radius:5px; background:#D4AF37; color:#06213f; font-weight:bold; cursor:pointer; margin-top:5px; }
  #feed { display:flex; flex-direction:column; align-items:center; gap:20px; margin:20px; }
  .post { border:2px solid #D4AF37; padding:10px; width:90%; max-width:500px; border-radius:10px; background: rgba(255,215,0,0.05); }
  .post img { width:100%; border-radius:10px; margin-top:5px; }
  .acoes { display:flex; gap:10px; margin-top:5px; }
  .comentarios { margin-top:10px; }
  .comentarios input { width:calc(100% - 90px); display:inline-block; }
  .comentarios button { display:inline-block; }
</style>
</head>
<body>
<h1>Aghatta XV</h1>
<div id="formulario">
  <input type="text" id="nome" placeholder="Seu nome">
  <textarea id="legenda" placeholder="Legenda / Mensagem"></textarea>
  <input type="file" id="arquivo" accept="image/*">
  <button onclick="postar()">Postar</button>
</div>
<div id="feed"></div>
</body>
</html>
