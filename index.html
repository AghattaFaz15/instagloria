<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√Ålbum Vivo da Aghatta ‚ú®</title>
  <!-- Tailwind via CDN (r√°pido para prot√≥tipo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* Toque sutil: estrelas de fundo */
    body { background: radial-gradient(1200px 500px at 10% 10%, rgba(255,255,255,.04), transparent), #0b1020; }
    .card { backdrop-filter: blur(8px); background: rgba(10,14,30,.6); }
    .gold { color: #f5d06f; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <header class="sticky top-0 z-20 bg-slate-900/80 backdrop-blur border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-semibold">üïäÔ∏è √Ålbum Vivo da Aghatta</h1>
      <nav class="flex gap-2">
        <button id="btnScrollTop" class="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-sm">Topo</button>
        <button id="btnScrollFeed" class="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-sm">Feed</button>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- BLOCO: Postar -->
    <section class="card rounded-2xl p-4 sm:p-6 border border-white/10">
      <h2 class="text-lg font-semibold mb-3">Compartilhe sua mem√≥ria ‚ú®</h2>
      <form id="postForm" class="grid sm:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div>
            <label class="text-sm opacity-80">Seu nome</label>
            <input id="authorInput" type="text" required placeholder="Ex.: Tio Jo√£o" class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
          <div>
            <label class="text-sm opacity-80">Legenda</label>
            <textarea id="captionInput" rows="3" maxlength="2200" placeholder="Deixe uma frase carinhosa‚Ä¶" class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
          </div>
          <div class="flex items-center gap-3">
            <input id="fileInput" type="file" accept="image/*,video/*" required class="block w-full text-sm" />
          </div>
          <div class="flex items-center gap-3">
            <button id="postBtn" type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50">Postar</button>
            <span id="uploadStatus" class="text-sm opacity-80"></span>
          </div>
        </div>
        <div class="rounded-xl border border-white/10 p-3">
          <p class="text-sm opacity-80 mb-2">Pr√©via</p>
          <div id="preview" class="aspect-video w-full bg-black/20 rounded-md grid place-items-center text-sm opacity-70">Sem m√≠dia</div>
        </div>
      </form>
      <p class="text-xs opacity-70 mt-3">Formatos aceitos: imagens (JPG/PNG/HEIC) e v√≠deos curtos (MP4/WEBM). Tamanho m√°ximo recomendado: 20MB.</p>
    </section>

    <!-- BLOCO: Avisos do Admin -->
    <section class="card rounded-2xl p-4 sm:p-6 border border-white/10">
      <h2 class="text-lg font-semibold mb-3">Recados do cora√ß√£o üíõ</h2>
      <form id="noticeForm" class="grid sm:grid-cols-6 gap-3 items-start">
        <input id="noticeAuthor" class="sm:col-span-2 px-3 py-2 rounded-xl bg-white/10 border border-white/10" placeholder="Quem est√° anunciando?" />
        <input id="noticeText" class="sm:col-span-3 px-3 py-2 rounded-xl bg-white/10 border border-white/10" placeholder="Escreva um recado para todos‚Ä¶" />
        <button id="noticeBtn" class="sm:col-span-1 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Publicar</button>
      </form>
      <ul id="noticesList" class="mt-4 space-y-2"></ul>
    </section>

    <!-- BLOCO: Feed -->
    <section>
      <h2 class="text-lg font-semibold mb-3">Feed ao vivo üì∏</h2>
      <div id="feed" class="grid md:grid-cols-2 gap-4"></div>
      <div id="emptyFeed" class="text-center opacity-70 mt-6 hidden">Seja o(a) primeiro(a) a postar ‚ú®</div>
    </section>
  </main>

  <footer class="text-center text-xs opacity-60 py-10">Feito com carinho para a Aghatta ‚Ä¢ <span class="gold">azul & dourado</span></footer>

  <!-- Firebase SDKs (modular). Atualize a vers√£o se necess√°rio. -->
  <script type="module">
    // IMPORTS (Firebase v10+)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, push, set, onValue, serverTimestamp, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
    import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

    // 1) Coloque aqui o SEU firebaseConfig (voc√™ j√° tem do projeto "livro-aghatta").
    // Dica: crie um app espec√≠fico para este √°lbum se quiser, mas pode reutilizar.
    const firebaseConfig = {
      apiKey: "COLAR_AQUI",
      authDomain: "COLAR_AQUI",
      databaseURL: "COLAR_AQUI",
      projectId: "COLAR_AQUI",
      storageBucket: "COLAR_AQUI",
      messagingSenderId: "COLAR_AQUI",
      appId: "COLAR_AQUI"
    };

    // 2) Inicializa
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Utilidades
    const uid = (() => {
      const k = 'aghatta_uid';
      let v = localStorage.getItem(k);
      if (!v) { v = crypto.randomUUID(); localStorage.setItem(k, v); }
      return v;
    })();
    const fmt = (d) => new Date(d).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

    // ======= Pr√©via do upload =======
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) { preview.textContent = 'Sem m√≠dia'; return; }
      const url = URL.createObjectURL(f);
      const isVideo = f.type.startsWith('video/');
      preview.innerHTML = isVideo
        ? `<video src="${url}" class="w-full h-full object-cover rounded-md" controls></video>`
        : `<img src="${url}" class="w-full h-full object-cover rounded-md" alt="pr√©via"/>`;
    });

    // ======= Postar =======
    const postForm = document.getElementById('postForm');
    const authorInput = document.getElementById('authorInput');
    const captionInput = document.getElementById('captionInput');
    const postBtn = document.getElementById('postBtn');
    const uploadStatus = document.getElementById('uploadStatus');

    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files?.[0];
      const author = authorInput.value.trim();
      const caption = captionInput.value.trim();
      if (!file || !author) return;
      postBtn.disabled = true;
      uploadStatus.textContent = 'Enviando‚Ä¶';

      try {
        const ext = file.name.split('.').pop()?.toLowerCase() || 'bin';
        const ts = Date.now();
        const storagePath = `posts/${ts}_${uid}.${ext}`;
        const storageRef = sref(storage, storagePath);
        const task = uploadBytesResumable(storageRef, file, { contentType: file.type });

        task.on('state_changed', (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          uploadStatus.textContent = `Enviando‚Ä¶ ${pct}%`;
        });

        await task; // terminou upload
        const url = await getDownloadURL(storageRef);
        const isVideo = file.type.startsWith('video/');

        const postRef = push(ref(db, 'posts'));
        await set(postRef, {
          id: postRef.key,
          author,
          caption,
          url,
          type: isVideo ? 'video' : 'image',
          createdAt: Date.now(),
          likes: 0
        });

        // Reset
        postForm.reset();
        preview.textContent = 'Sem m√≠dia';
        uploadStatus.textContent = 'Publicado!';
        setTimeout(() => uploadStatus.textContent = '', 1500);
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = 'Falhou. Tente novamente.';
      } finally {
        postBtn.disabled = false;
      }
    });

    // ======= Recados do Admin (n√£o exige login, √© um quadro simples) =======
    const noticeForm = document.getElementById('noticeForm');
    const noticeAuthor = document.getElementById('noticeAuthor');
    const noticeText = document.getElementById('noticeText');
    const noticesList = document.getElementById('noticesList');

    noticeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const a = (noticeAuthor.value || 'An√∫ncio').trim();
      const t = (noticeText.value || '').trim();
      if (!t) return;
      const r = push(ref(db, 'notices'));
      await set(r, { id: r.key, author: a, text: t, createdAt: Date.now() });
      noticeForm.reset();
    });

    onValue(query(ref(db, 'notices'), limitToLast(50)), (snap) => {
      const data = snap.val() || {};
      const arr = Object.values(data).sort((a,b) => b.createdAt - a.createdAt);
      noticesList.innerHTML = arr.map(n => `
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="text-sm opacity-80">${n.author} ‚Ä¢ ${fmt(n.createdAt)}</div>
          <div class="mt-1">${escapeHtml(n.text)}</div>
        </li>
      `).join('');
    });

    // ======= Feed =======
    const feed = document.getElementById('feed');
    const emptyFeed = document.getElementById('emptyFeed');

    onValue(query(ref(db, 'posts'), limitToLast(200)), (snap) => {
      const data = snap.val() || {};
      const posts = Object.values(data).sort((a,b) => b.createdAt - a.createdAt);
      emptyFeed.classList.toggle('hidden', posts.length > 0);
      feed.innerHTML = posts.map(renderPost).join('');
      // Re-anexa handlers de like/coment√°rio
      attachPostHandlers(posts.map(p => p.id));
    });

    function renderPost(p){
      const liked = localStorage.getItem('like_'+p.id) === '1';
      const media = p.type === 'video'
        ? `<video src="${p.url}" class="w-full rounded-xl" controls playsinline></video>`
        : `<img src="${p.url}" alt="post" class="w-full rounded-xl"/>`;

      return `
        <article class="card rounded-2xl p-4 border border-white/10 space-y-3" id="post_${p.id}">
          <header class="flex items-center justify-between text-sm opacity-80">
            <div>üë§ <strong>${escapeHtml(p.author||'Convidado')}</strong></div>
            <div>${fmt(p.createdAt||Date.now())}</div>
          </header>
          <div>${media}</div>
          ${p.caption ? `<p class="whitespace-pre-line">${linkify(escapeHtml(p.caption))}</p>` : ''}
          <div class="flex items-center gap-3">
            <button data-like="${p.id}" class="px-3 py-1.5 rounded-xl ${liked?'bg-pink-700':'bg-pink-600 hover:bg-pink-500'}">‚ù§Ô∏è <span data-like-count="${p.id}">${p.likes||0}</span></button>
          </div>
          <div class="pt-2 border-t border-white/10">
            <div id="comments_${p.id}" class="space-y-2"></div>
            <form data-comment-form="${p.id}" class="mt-2 grid grid-cols-5 gap-2">
              <input name="name" class="col-span-2 px-3 py-2 rounded-xl bg-white/10 border border-white/10" placeholder="Seu nome" required />
              <input name="text" class="col-span-3 px-3 py-2 rounded-xl bg-white/10 border border-white/10" placeholder="Escreva um coment√°rio" required />
            </form>
          </div>
        </article>`;
    }

    function attachPostHandlers(ids){
      ids.forEach(id => {
        // Likes
        const likeBtn = document.querySelector(`button[data-like="${id}"]`);
        if (likeBtn && !likeBtn.dataset.bound){
          likeBtn.dataset.bound = '1';
          likeBtn.addEventListener('click', async () => {
            if (localStorage.getItem('like_'+id) === '1') return; // simples anti-spam
            // Incremento otimista
            const countEl = document.querySelector(`[data-like-count="${id}"]`);
            countEl.textContent = String(Number(countEl.textContent||'0') + 1);
            localStorage.setItem('like_'+id, '1');
            likeBtn.classList.remove('hover:bg-pink-500');
            likeBtn.classList.add('bg-pink-700');
            // Atualiza no DB
            const likeRef = ref(db, `posts/${id}/likes`);
            onValue(likeRef, async (snap) => { /* noop live */ }, { onlyOnce: true });
            // Usando transaction simplificada via leitura+set
            // (Para produ√ß√£o, use runTransaction do SDK de DB)
            const postRef = ref(db, `posts/${id}`);
            onValue(postRef, async (s) => {
              const v = s.val();
              if (!v) return;
              set(postRef, { ...v, likes: (v.likes||0) + 1 });
            }, { onlyOnce: true });
          });
        }
        // Coment√°rios submit on Enter
        const form = document.querySelector(`form[data-comment-form="${id}"]`);
        if (form && !form.dataset.bound){
          form.dataset.bound = '1';
          form.addEventListener('submit', (e) => e.preventDefault());
          form.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              const name = form.elements.namedItem('name').value.trim();
              const text = form.elements.namedItem('text').value.trim();
              if (!name || !text) return;
              const cRef = push(ref(db, `comments/${id}`));
              await set(cRef, { id: cRef.key, name, text, createdAt: Date.now() });
              form.reset();
            }
          });
          // Live load dos coment√°rios
          onValue(ref(db, `comments/${id}`), (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort((a,b)=> a.createdAt - b.createdAt);
            const box = document.getElementById(`comments_${id}`);
            box.innerHTML = arr.map(c => `
              <div class="text-sm">
                <span class="opacity-80">${escapeHtml(c.name)}</span>:
                <span>${linkify(escapeHtml(c.text))}</span>
                <span class="opacity-50 text-xs"> ‚Ä¢ ${fmt(c.createdAt)}</span>
              </div>
            `).join('');
          });
        }
      });
    }

    // Pequenas prote√ß√µes HTML
    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));
    }
    function linkify(text=''){
      return text.replace(/(https?:\/\/[^\s]+)/g, '<a class="underline hover:opacity-80" href="$1" target="_blank" rel="noopener">$1<\/a>');
    }

    // Scroll helpers
    document.getElementById('btnScrollTop').onclick = ()=> window.scrollTo({ top: 0, behavior: 'smooth' });
    document.getElementById('btnScrollFeed').onclick = ()=> document.getElementById('feed').scrollIntoView({ behavior: 'smooth' });
  </script>

  <!-- Sugest√£o de regras (cole no Realtime Database Rules e Storage Rules). Leia abaixo as notas. -->
  <script>
  /*
  ========================= Realtime Database Rules (exemplo) =========================
  {
    "rules": {
      ".read": true,
      ".write": true,
      "posts": {
        "$postId": {
          ".validate": 
            newData.hasChildren(['author','caption','url','type','createdAt','likes']) &&
            newData.child('author').isString() && newData.child('author').val().length <= 60 &&
            newData.child('caption').isString() && newData.child('caption').val().length <= 2200 &&
            (newData.child('type').val() === 'image' || newData.child('type').val() === 'video') &&
            newData.child('url').isString() && newData.child('createdAt').isNumber()
        }
      },
      "comments": {
        "$postId": {
          "$cid": {
            ".validate": newData.hasChildren(['name','text','createdAt']) &&
              newData.child('name').isString() && newData.child('name').val().length <= 60 &&
              newData.child('text').isString() && newData.child('text').val().length <= 1000 &&
              newData.child('createdAt').isNumber()
          }
        }
      },
      "notices": { 
        "$nid": {
          ".validate": newData.hasChildren(['author','text','createdAt'])
        }
      }
    }
  }

  ============================== Storage Rules (exemplo) ==============================
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      match /posts/{allPaths=**} {
        allow read: if true;
        allow write: if request.resource.contentType.matches('image/.*') || request.resource.contentType.matches('video/.*');
      }
    }
  }

  *Para produ√ß√£o real, considere ativar Authentication (an√¥nima) e regras mais restritas.*
  */
  </script>
</body>
</html>
