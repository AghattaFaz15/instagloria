<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aghatta XV</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: url("fundo.jpeg") no-repeat center center fixed;
  background-size: cover;
  color:#fff;
  font-family:sans-serif;
}
.overlay {
  background: radial-gradient(1200px 500px at 10% 10%, rgba(255,255,255,.04), transparent),
              linear-gradient(180deg, rgba(11,59,143,.9) 0%, rgba(6,33,63,.95) 100%);
}
.gold{color:#D4AF37;}
.card{backdrop-filter: blur(8px); background: rgba(10,14,30,.7); border-radius:1rem; padding:1rem; margin-bottom:1rem;}
button{cursor:pointer;}
textarea,input{background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1); border-radius:0.75rem; padding:0.5rem; color:#fff; width:100%;}
</style>
</head>
<body class="min-h-screen overlay">
<header class="sticky top-0 z-20 bg-slate-900/80 backdrop-blur border-b border-white/10 p-4 flex justify-between items-center">
<h1 class="text-xl sm:text-2xl font-semibold">üïäÔ∏è Aghatta XV</h1>
</header>

<main class="max-w-3xl mx-auto px-4 py-6 space-y-6">

<!-- Formul√°rio de Post -->
<div class="card">
<h2 class="text-lg font-semibold mb-2">Compartilhe sua mem√≥ria ‚ú®</h2>
<form id="postForm" class="space-y-3">
<input id="authorInput" type="text" placeholder="Seu nome" required />
<textarea id="captionInput" placeholder="Escreva uma mensagem ou legenda..."></textarea>
<input id="fileInput" type="file" accept="image/*,video/*" />
<button type="submit" id="postBtn" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-xl">Postar</button>
<div id="uploadStatus" class="text-sm mt-1"></div>
<div id="preview" class="mt-2 aspect-video w-full bg-black/20 rounded-md grid place-items-center text-sm">Sem m√≠dia</div>
</form>
</div>

<!-- Feed -->
<div id="feed" class="space-y-4"></div>
<div id="emptyFeed" class="text-center opacity-70 mt-6 hidden">Seja o(a) primeiro(a) a postar ‚ú®</div>

<footer class="text-center text-xs opacity-60 py-10">
Feito com carinho para a Aghatta ‚Ä¢ <span class="gold">azul & dourado</span>
</footer>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getDatabase, ref, push, set, onValue, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCWq5k87voGQHlRPquvI1P5W1eme32E5f4",
  authDomain: "livro-aghatta.firebaseapp.com",
  databaseURL: "https://livro-aghatta-default-rtdb.firebaseio.com",
  projectId: "livro-aghatta",
  storageBucket: "livro-aghatta.appspot.com", 
  messagingSenderId: "491625108244",
  appId: "1:491625108244:web:3afdfda239f9d0904ca801"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// UID
const uid = (() => {
  const k = 'aghatta_uid';
  let v = localStorage.getItem(k);
  if (!v) { v = crypto.randomUUID(); localStorage.setItem(k,v); }
  return v;
})();

// Preview
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files?.[0];
  if(!f){ preview.textContent='Sem m√≠dia'; return; }
  const url = URL.createObjectURL(f);
  preview.innerHTML = f.type.startsWith('video/')
    ? `<video src="${url}" class="w-full h-full object-cover rounded-md" controls></video>`
    : `<img src="${url}" class="w-full h-full object-cover rounded-md" alt="pr√©via"/>`;
});

// Formul√°rio Post
const postForm = document.getElementById('postForm');
const authorInput = document.getElementById('authorInput');
const captionInput = document.getElementById('captionInput');
const postBtn = document.getElementById('postBtn');
const uploadStatus = document.getElementById('uploadStatus');
const feed = document.getElementById('feed');
const emptyFeed = document.getElementById('emptyFeed');

function escapeHtml(str=''){return str.replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function linkify(text=''){return text.replace(/(https?:\/\/[^\s]+)/g, '<a class="underline" href="$1" target="_blank" rel="noopener">$1</a>');}

postForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const file = fileInput.files?.[0];
  const author = authorInput.value.trim();
  const caption = captionInput.value.trim();
  if(!author && !caption) return;

  postBtn.disabled=true;
  uploadStatus.textContent='Publicando...';

  try{
    let url = null, type = "text";
    if(file){
      const ext = file.name.split('.').pop()?.toLowerCase()||'bin';
      const ts = Date.now();
      const storagePath = `posts/${ts}_${uid}.${ext}`;
      const storageRef = sref(storage, storagePath);
      const task = uploadBytesResumable(storageRef,file,{contentType:file.type});
      task.on('state_changed', snap=>{
        const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
        uploadStatus.textContent=`Enviando m√≠dia‚Ä¶ ${pct}%`;
      });
      await task;
      url = await getDownloadURL(storageRef);
      type = file.type.startsWith('video/') ? 'video' : 'image';
    }

    const postRef = push(ref(db,'posts'));
    await set(postRef,{
      id:postRef.key,
      author,
      caption,
      url,
      type,
      likes:0,
      createdAt:Date.now()
    });

    postForm.reset();
    preview.textContent='Sem m√≠dia';
    uploadStatus.textContent='Publicado!';
    setTimeout(()=>uploadStatus.textContent='',1500);
  }catch(err){
    console.error(err);
    uploadStatus.textContent='Erro ao publicar';
  } finally {
    postBtn.disabled=false;
  }
});

// Render Feed
onValue(query(ref(db,'posts'),limitToLast(200)), snap=>{
  const data = snap.val()||{};
  const posts = Object.values(data).sort((a,b)=>b.createdAt-a.createdAt);
  emptyFeed.classList.toggle('hidden',posts.length>0);
  feed.innerHTML = posts.map(p=>{
    const liked = localStorage.getItem('like_'+p.id)==='1';
    let media = "";
    if(p.type==="video") media = `<video src="${p.url}" class="w-full rounded-md" controls></video>`;
    if(p.type==="image") media = `<img src="${p.url}" class="w-full rounded-md"/>`;

    return `
      <div class="card">
        <div class="flex justify-between text-sm opacity-80 mb-1">
          <div>üë§ <strong>${escapeHtml(p.author||"An√¥nimo")}</strong></div>
          <div>${new Date(p.createdAt).toLocaleString('pt-BR')}</div>
        </div>
        ${media}
        ${p.caption?`<p class="mt-1">${linkify(escapeHtml(p.caption))}</p>`:''}
        <button data-like="${p.id}" class="mt-2 px-3 py-1.5 rounded-xl ${liked?'bg-pink-700':'bg-pink-600 hover:bg-pink-500'}">‚ù§Ô∏è <span data-like-count="${p.id}">${p.likes||0}</span></button>
      </div>`;
  }).join('');
});
</script>
</body>
</html>
