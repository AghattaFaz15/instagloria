<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Aghatta XV</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<main>
  <section>
    <h2>Compartilhe sua memória ✨</h2>
    <form id="postForm">
      <input type="text" id="authorInput" placeholder="Seu nome" required>
      <textarea id="captionInput" placeholder="Deixe uma frase carinhosa…"></textarea>
      <input type="file" id="fileInput" accept="image/*,video/*" required>
      <button type="submit">Postar</button>
      <span id="uploadStatus"></span>
    </form>
    <div id="preview">Prévia: sem mídia</div>
  </section>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getDatabase, ref, push, set } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCWq5k87voGQHlRPquvI1P5W1eme32E5f4",
  authDomain: "livro-aghatta.firebaseapp.com",
  databaseURL: "https://livro-aghatta-default-rtdb.firebaseio.com",
  projectId: "livro-aghatta",
  storageBucket: "livro-aghatta.firebasestorage.app",
  messagingSenderId: "491625108244",
  appId: "1:491625108244:web:3afdfda239f9d0904ca801"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const uid = (() => { let k='aghatta_uid'; let v = localStorage.getItem(k); if(!v){v=crypto.randomUUID(); localStorage.setItem(k,v);} return v; })();

// Preview
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files[0];
  if(!f){ preview.textContent='Prévia: sem mídia'; return; }
  const url = URL.createObjectURL(f);
  preview.innerHTML = f.type.startsWith('video/') ? `<video src="${url}" controls></video>` : `<img src="${url}">`;
});

// Submit
const postForm = document.getElementById('postForm');
const authorInput = document.getElementById('authorInput');
const captionInput = document.getElementById('captionInput');
const uploadStatus = document.getElementById('uploadStatus');

postForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const file = fileInput.files[0], author=authorInput.value.trim(), caption=captionInput.value.trim();
  if(!file || !author) return;
  postForm.querySelector('button').disabled=true;
  uploadStatus.textContent='Enviando…';
  try{
    const ext=file.name.split('.').pop(), ts=Date.now(), storageRef=sref(storage, `posts/${ts}_${uid}.${ext}`);
    const task = uploadBytesResumable(storageRef, file, {contentType:file.type});
    task.on('state_changed', snap=>{
      const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      uploadStatus.textContent=`Enviando… ${pct}%`;
    });
    await task;
    const url=await getDownloadURL(storageRef);
    const isVideo=file.type.startsWith('video/');
    const postRef=push(ref(db,'posts'));
    await set(postRef,{id:postRef.key,author,caption,url,type:isVideo?'video':'image',createdAt:Date.now(),likes:0});
    postForm.reset(); preview.textContent='Prévia: sem mídia'; uploadStatus.textContent='Publicado!';
    setTimeout(()=>uploadStatus.textContent='',1500);
  }catch(err){ console.error(err); uploadStatus.textContent='Falhou. Tente novamente.'; }
  finally{ postForm.querySelector('button').disabled=false; }
});
</script>
</body>
</html>
