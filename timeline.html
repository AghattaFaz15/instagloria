<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timeline Aghatta XV</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<main>
  <section>
    <h2>Feed ao vivo üì∏</h2>
    <div id="feed"></div>
    <div id="emptyFeed">Seja o(a) primeiro(a) a postar ‚ú®</div>
  </section>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getDatabase, ref, onValue, query, limitToLast, set } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCWq5k87voGQHlRPquvI1P5W1eme32E5f4",
  authDomain: "livro-aghatta.firebaseapp.com",
  databaseURL: "https://livro-aghatta-default-rtdb.firebaseio.com",
  projectId: "livro-aghatta",
  storageBucket: "livro-aghatta.firebasestorage.app",
  messagingSenderId: "491625108244",
  appId: "1:491625108244:web:3afdfda239f9d0904ca801"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const feed = document.getElementById('feed');
const emptyFeed = document.getElementById('emptyFeed');
const uid = (()=>{let k='aghatta_uid'; let v=localStorage.getItem(k); if(!v){v=crypto.randomUUID(); localStorage.setItem(k,v);} return v; })();
const fmt = d => new Date(d).toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'});

onValue(query(ref(db,'posts'), limitToLast(200)), snap=>{
  const data = snap.val()||{};
  const posts = Object.values(data).sort((a,b)=>b.createdAt-a.createdAt);
  emptyFeed.classList.toggle('hidden', posts.length>0);
  feed.innerHTML = posts.map(p=>{
    const liked = localStorage.getItem('like_'+p.id)==='1';
    const media = p.type==='video' ? `<video src="${p.url}" controls></video>` : `<img src="${p.url}">`;
    return `<div class="feed-card">
      <div><strong>${p.author}</strong> ‚Ä¢ ${fmt(p.createdAt)}</div>
      ${media}
      ${p.caption?`<p>${p.caption}</p>`:''}
      <button class="like-btn" onclick="likePost('${p.id}')">‚ù§Ô∏è ${p.likes||0}</button>
    </div>`;
  }).join('');
});

window.likePost = async (id)=>{
  if(localStorage.getItem('like_'+id)==='1') return;
  localStorage.setItem('like_'+id,'1');
  const postRef = ref(db, `posts/${id}`);
  onValue(postRef, s=>{
    const v = s.val(); if(!v) return;
    set(postRef, {...v, likes:(v.likes||0)+1});
  }, {onlyOnce:true});
};
</script>
</body>
</html>
